(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/writeemail/writeemail"],{"1cc0":function(t,e,i){"use strict";(function(t){i("02d9");n(i("66fd"));var e=n(i("544f"));function n(t){return t&&t.__esModule?t:{default:t}}wx.__webpack_require_UNI_MP_PLUGIN__=i,t(e.default)}).call(this,i("543d")["createPage"])},2705:function(t,e,i){"use strict";i.d(e,"b",(function(){return o})),i.d(e,"c",(function(){return s})),i.d(e,"a",(function(){return n}));var n={EmailBlock:function(){return i.e("components/EmailBlock/EmailBlock").then(i.bind(null,"d7c2"))}},o=function(){var t=this,e=t.$createElement;t._self._c},s=[]},"2a75":function(t,e,i){"use strict";i.r(e);var n=i("41e1"),o=i.n(n);for(var s in n)"default"!==s&&function(t){i.d(e,t,(function(){return n[t]}))}(s);e["default"]=o.a},"3c70":function(t,e,i){"use strict";var n=i("792c"),o=i.n(n);o.a},"41e1":function(t,e,i){"use strict";(function(t){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var i={data:function(){var e=t.createAnimation({transformOrigin:"50% 50%",duration:200,timingFunction:"ease",delay:0}),i=t.createAnimation({transformOrigin:"50% 50%",duration:400,timingFunction:"ease",delay:0}),n=t.createAnimation({transformOrigin:"50% 50%",duration:100,timingFunction:"ease",delay:0});return{currentTargetRef:"",animation_bg:e,blackBGData:{},animation_w:i,textareaData:{},INPUTFLAG:!1,animation_c:n,confirmBData:{},jianpanConfirm:!1,fuck1content:"",textareaLS:"",blockObjectList:[],addTextFlag:!0,addPicFlag:!0,whiteNumber:4,addFlag:!0,session:"",letterid:"",nowType:0,biaoti:"写信",sentFlag:!0,xuanfuFlag:!0,blockclickclock:!1}},methods:{uploadletter:function(e,i,n){var o=this;t.showLoading({title:e}),t.request({url:"https://afflatus.xyz/updateEmail",data:{session:this.session,letterid:this.letterid,letterState:i,blockObjectList:this.blockObjectList},method:"POST",success:function(e){if(console.log(e),200==e.data.status){var i=0,s=0,c=null;for(var a in o.blockObjectList)"text"!=o.blockObjectList[a].type&&1==o.blockObjectList[a].contentChange&&""!=o.blockObjectList[a].content&&(i+=1);setTimeout((function(){var e=new Promise((function(e,n){for(var a in o.blockObjectList)"text"!=o.blockObjectList[a].type&&1==o.blockObjectList[a].contentChange&&""!=o.blockObjectList[a].content&&t.uploadFile({url:"https://afflatus.xyz/uploadFile",filePath:o.blockObjectList[a].content,name:"file",header:{session:o.session,letterid:o.letterid,blockid:o.blockObjectList[a].id,blockType:o.blockObjectList[a].blockType},success:function(t){var e=JSON.parse(t.data);200==e.status?s+=1:(console.log("ooooooooo"),n("上传失败"))},fail:function(){console.log("hhhhhhhh"),n("上传失败")}});setTimeout((function(){n("上传失败")}),2e4),c=setInterval((function(){i==s&&(console.log("成功上传"),e("成功上传"))}),100)}));e.then((function(e){clearInterval(c),t.hideLoading(),"sent"==n?t.redirectTo({url:"../index/index"}):"return"==n&&t.redirectTo({url:"../setemail/setemail?session="+o.session+"&haveSave=true&letterid="+o.letterid})}),(function(e){console.log("这里啊"),e&&(t.hideLoading(),t.showToast({title:"服务器较忙",mask:!0,icon:"none",duration:2e3}))}))}),10)}else console.log("ffffff"),t.hideLoading(),t.showToast({title:"服务器较忙",mask:!0,icon:"none",duration:2e3})},fail:function(){console.log("kkkkkkk"),t.hideLoading(),t.showToast({title:"服务器较忙",mask:!0,icon:"none",duration:2e3})}})},returnIndex:function(){if(this.blockclickclock)return t.redirectTo({url:"../setemail/setemail?session="+this.session+"&haveSave=true&letterid="+this.letterid+"&nowType="+this.nowType}),0;this.uploadletter("保存中...",0,"return")},editFunction:function(e){if(this.blockclickclock)return console.log("父： 我点击了子。"),"picture"==this.$refs[e.currentTarget.dataset.ref][0].blockType&&t.previewImage({urls:[this.$refs[e.currentTarget.dataset.ref][0].BlockContent]}),0;var i=this.currentTargetRef;if(this.currentTargetRef=e.currentTarget.dataset.ref,""!=i&&i!=this.currentTargetRef&&this.$refs[i][0].returnBack(),"edit"==this.$refs[this.currentTargetRef][0].model){if("text"==this.$refs[this.currentTargetRef][0].blockType){var n=0;while(1){if(this.blockObjectList[n]["ref"]==this.currentTargetRef){this.textareaLS=this.blockObjectList[n]["content"];break}if(n+=1,n>=this.blockObjectList.length)break}this.animation_bg.height("100%"),this.animation_bg.width("100%"),this.animation_bg.left("0px"),this.animation_bg.top("0px"),this.animation_bg.opacity(.7),this.animation_bg.step(),this.animation_w.width("700rpx"),this.animation_w.height("30%"),this.animation_w.opacity(.7),this.animation_w.left("9px"),this.animation_w.top("20%"),this.animation_w.step(),this.animation_c.opacity(.7),this.animation_c.width("100rpx"),this.animation_c.height("100rpx"),this.animation_c.step(),this.blackBGData=this.animation_bg.export(),this.textareaData=this.animation_w.export(),this.confirmBData=this.animation_c.export(),this.INPUTFLAG=!0}else if("picture"==this.$refs[this.currentTargetRef][0].blockType){var o=this;t.chooseImage({count:1,success:function(e){var i=e.tempFilePaths[0].split(".");if(i=i[i.length-1],"jpg"==i||"png"==i||"jpeg"==i||"gif"==i||"JPG"==i||"PNG"==i||"JPEG"==i||"GIF"==i)if(e.tempFiles[0].size>5242880){var n=100-(e.tempFiles[0].size-5242880)/e.tempFiles[0].size*100;console.log("quality"),console.log(n),t.compressImage({src:e.tempFilePaths[0],quality:n,success:function(t){o.houchuliPic(t.tempFilePath)}})}else o.houchuliPic(e.tempFilePaths[0]);else t.showToast({title:"不支持的格式",mask:!0,icon:"none",duration:2e3})}})}}else if("delete"==this.$refs[this.currentTargetRef][0].model){var s=0;while(1){if(this.blockObjectList[s].ref==this.currentTargetRef){this.$refs[this.currentTargetRef][0].returnBack();var c=s+1;while(1){if(c>this.blockObjectList.length-1)break;this.blockObjectList[c].orderNum-=1,this.blockObjectList[c].orderChange=1,c+=1}this.blockObjectList.splice(s,1);break}if(s+=1,s>this.blockObjectList.length-1)break}this.currentTargetRef=""}else if("shangMove"==this.$refs[this.currentTargetRef][0].model){s=0;while(1){if(this.blockObjectList[s].ref==this.currentTargetRef){if(0==s)break;this.$refs[this.currentTargetRef][0].returnBack();var a=this.blockObjectList[s-1];this.blockObjectList[s-1].orderChange=1,this.blockObjectList[s].orderChange=1,this.blockObjectList[s-1].orderNum+=1,this.blockObjectList[s].orderNum-=1,this.blockObjectList.splice(s-1,1,this.blockObjectList[s]),this.blockObjectList.splice(s,1,a);break}if(s+=1,s>this.blockObjectList.length-1)break}}else if("xiaMove"==this.$refs[this.currentTargetRef][0].model){s=0;while(1){if(this.blockObjectList[s].ref==this.currentTargetRef){if(s==this.blockObjectList.length-1)break;this.$refs[this.currentTargetRef][0].returnBack();a=this.blockObjectList[s+1];this.blockObjectList[s+1].orderChange=1,this.blockObjectList[s].orderChange=1,this.blockObjectList[s+1].orderNum-=1,this.blockObjectList[s].orderNum+=1,this.blockObjectList.splice(s+1,1,this.blockObjectList[s]),this.blockObjectList.splice(s,1,a);break}if(s+=1,s>this.blockObjectList.length-1)break}}},houchuliPic:function(e){var i=this,n=0;console.log(e);while(1)if(i.blockObjectList[n]["ref"]==i.currentTargetRef&&function(){var o=n;console.log("hello"),t.saveFile({tempFilePath:e,success:function(t){console.log("已保存"),console.log(e),i.blockObjectList[o]["content"]=t.savedFilePath,i.blockObjectList[o]["content"]!=i.blockObjectList[o]["contentLast"]?i.blockObjectList[o]["contentChange"]=1:i.blockObjectList[o]["contentChange"]=0,n=i.blockObjectList.length}})}(),n+=1,n>=i.blockObjectList.length)break;i.$refs[i.currentTargetRef][0].model=""},confirmF:function(){this.INPUTFLAG=!1,this.animation_bg.height("0rpx"),this.animation_bg.width("0rpx"),this.animation_bg.left("375rpx"),this.animation_bg.top("375rpx"),this.animation_bg.opacity(0),this.animation_bg.step(),this.animation_w.width("0rpx"),this.animation_w.height("0rpx"),this.animation_w.opacity(0),this.animation_w.left("375rpx"),this.animation_w.top("375rpx"),this.animation_w.step(),this.animation_c.opacity(.7),this.animation_c.width("0rpx"),this.animation_c.height("0rpx"),this.animation_c.step(),this.blackBGData=this.animation_bg.export(),this.textareaData=this.animation_w.export(),this.confirmBData=this.animation_c.export();var t=0;while(1){if(this.blockObjectList[t]["ref"]==this.currentTargetRef){this.blockObjectList[t]["content"]=this.textareaLS,this.blockObjectList[t]["content"]!=this.blockObjectList[t]["contentLast"]?this.blockObjectList[t]["contentChange"]=1:this.blockObjectList[t]["contentChange"]=0;break}if(t+=1,t>=this.blockObjectList.length)break}this.$refs[this.currentTargetRef][0].model=""},whiteClick:function(){if(this.blockclickclock)return 0;console.log(this.blockObjectList),""!=this.currentTargetRef&&(this.$refs[this.currentTargetRef][0].model="",this.$refs[this.currentTargetRef][0].returnBack())},addText:function(){var t=this;if(this.addFlag){this.addFlag=!1;var e=new Date,i=e.getFullYear(),n=e.getMonth()+1,o=e.getDate(),s=e.getHours()<10?"0"+e.getHours():e.getHours(),c=e.getMinutes()<10?"0"+e.getMinutes():e.getMinutes(),a=e.getSeconds()<10?"0"+e.getSeconds():e.getSeconds();n>=1&&n<=9&&(n="0"+n),o>=0&&o<=9&&(o="0"+o),s>=0&&s<=9&&(s="0"+s),c>=0&&c<=9&&(c="0"+c),a>=0&&a<=9&&(a="0"+a);var r=String(i)+String(n)+String(o)+String(s)+String(c)+String(a),l=r;this.blockObjectList.push({id:r,ref:l,type:"text",blockType:0,content:"",contentLast:"",contentChange:1,orderNum:-1,orderChange:1,newblock:!0}),this.blockObjectList[this.blockObjectList.length-1].orderNum=this.blockObjectList.length,setTimeout((function(){t.addFlag=!0}),1100)}},addPic:function(){var t=this;if(this.addFlag){this.addFlag=!1;var e=new Date,i=e.getFullYear(),n=e.getMonth()+1,o=e.getDate(),s=e.getHours()<10?"0"+e.getHours():e.getHours(),c=e.getMinutes()<10?"0"+e.getMinutes():e.getMinutes(),a=e.getSeconds()<10?"0"+e.getSeconds():e.getSeconds();n>=1&&n<=9&&(n="0"+n),o>=0&&o<=9&&(o="0"+o),s>=0&&s<=9&&(s="0"+s),c>=0&&c<=9&&(c="0"+c),a>=0&&a<=9&&(a="0"+a);var r=String(i)+String(n)+String(o)+String(s)+String(c)+String(a),l=r;this.blockObjectList.push({id:r,ref:l,type:"picture",blockType:1,content:"",contentLast:"",contentChange:1,orderNum:-1,orderChange:1,newblock:!0}),this.blockObjectList[this.blockObjectList.length-1].orderNum=this.blockObjectList.length,setTimeout((function(){t.addFlag=!0}),1100)}},sentFunction:function(){var e=this;t.requestSubscribeMessage({tmplIds:["Ue2gQHM_jKb-Z6iPwGAf69NkkURm-IqmjadGqrLgtOk"],success:function(i){console.log(i),-1!=JSON.stringify(i).indexOf("accept")?e.blockObjectList.length<1?t.showToast({title:"无内容无法发送",icon:"none",mask:!0}):t.showModal({title:"发送邮件",content:"发送后将无法编辑",success:function(t){t.confirm&&e.uploadletter("发送中...",1,"sent")}}):t.showToast({title:"请允许邮件提醒",mask:!0,icon:"none",duration:2e3})}})}},onLoad:function(e){t.showLoading({title:"加载中"});var i=this;this.session=e.session,this.letterid=e.letterid,2==e.nowType&&(this.nowType=2,this.biaoti="信件内容",this.sentFlag=!1,this.xuanfuFlag=!1,this.blockclickclock=!0);var n=[];t.request({url:"https://afflatus.xyz/loadLetter",data:{session:this.session,letterid:this.letterid},method:"POST",success:function(e){if(console.log(e),200==e.data.status){n=e.data.data,console.log(n);var o=new Array(n.length),s=null,c=n.length,a=0,r=new Promise((function(e,r){setTimeout((function(){r("加载失败")}),2e4),s=setInterval((function(){c==a&&(console.log("加载成功"),e("加载成功")),console.log("sum:"+c+" success:"+a)}),1e3);var l=[];for(var h in n)l[h]=Number(h);n.forEach((function(e){var n={id:"",ref:"",type:"text",blockType:0,content:"",contentLast:"",contentChange:0,orderNum:-1,orderChange:1,newblock:!0};n["id"]=e.blockid,n["ref"]=e.blockid,n["blockType"]=e.blockType,n["orderNum"]=e.orderNum,0==e.blockType?n["type"]="text":1==e.blockType?n["type"]="picture":2==e.blockType&&(n["type"]="music"),n["orderChange"]=0,n["newblock"]=!1,0==n["blockType"]?(n["content"]=e.content,n["contentLast"]=n["content"],o[n["orderNum"]-1]=n,a+=1):(n["content"]=e.content,""!=n["content"]?t.getSavedFileInfo({filePath:n["content"],success:function(t){o[n["orderNum"]-1]=n,a+=1},fail:function(){console.log("地资源找不到，需要下载"),t.downloadFile({url:"https://afflatus.xyz/download",header:{session:i.session,letterid:i.letterid,blockid:e.blockid,blockType:String(e.blockType)},success:function(s){if(200===s.statusCode){console.log("下载成功");var c=s.tempFilePath;console.log("res.tempFilePath = "+s.tempFilePath),t.saveFile({tempFilePath:c,success:function(s){console.log("保存路径为: "+s.savedFilePath),n["content"]=s.savedFilePath,n["contentLast"]=n["content"],a+=1,o[n["orderNum"]-1]=n,t.request({url:"https://afflatus.xyz/updatePath",data:{session:i.session,letterid:i.letterid,blockid:e.blockid,changecontent:s.savedFilePath},method:"POST",success:function(t){console.log("更新成功啊")},fail:function(t){console.log("更新失败 :"+t)}})},fail:function(t){console.log("不能保存"),console.log("mytempFilePath="+c),console.log(t)}})}},fail:function(t){console.log("下载失败 "+t)}})}}):(n["contentLast"]=n["content"],o[n["orderNum"]-1]=n,a+=1))}))}));r.then((function(e){clearInterval(s),i.blockObjectList=o,console.log(o),t.hideLoading()}),(function(e){clearInterval(s),t.hideLoading(),t.showToast({title:"服务器较忙",mask:!0,icon:"none",duration:2e3})}))}},fail:function(){t.hideLoading()}})}};e.default=i}).call(this,i("543d")["default"])},"544f":function(t,e,i){"use strict";i.r(e);var n=i("2705"),o=i("2a75");for(var s in o)"default"!==s&&function(t){i.d(e,t,(function(){return o[t]}))}(s);i("3c70");var c,a=i("f0c5"),r=Object(a["a"])(o["default"],n["b"],n["c"],!1,null,null,null,!1,n["a"],c);e["default"]=r.exports},"792c":function(t,e,i){}},[["1cc0","common/runtime","common/vendor"]]]);